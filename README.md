# RideQwik API

A RESTful API built with Go and Gin framework for a ride-sharing aggregator application that integrates with multiple ride platforms (Uber, Lyft, etc.).

## Features

- ✅ RESTful API with Gin framework
- ✅ PostgreSQL database with migrations
- ✅ **sqlc** for type-safe SQL queries
- ✅ JWT-based authentication
- ✅ User registration and login
- ✅ Uber OAuth integration (tokens stored on frontend)
- ✅ Ride price comparison across platforms
- ✅ Clean architecture with separation of concerns
- ✅ pgx/v5 connection pooling
- ✅ CORS middleware
- ✅ Error handling middleware

## Project Structure

```
.
├── main.go                          # Application entry point
├── go.mod                           # Go module dependencies
├── sqlc.yaml                        # sqlc configuration
├── Makefile                         # Build and development commands
└── internal/
    ├── config/                      # Configuration management
    │   └── config.go
    ├── database/                    # Database setup and migrations
    │   ├── postgres.go              # DB connection pool & migrations
    │   ├── migrations/              # SQL migration files
    │   │   └── 001_create_users_table.sql
    │   └── queries/                 # SQL queries (sqlc input)
    │       └── users.sql
    ├── db/                          # Generated by sqlc (type-safe queries)
    │   ├── db.go
    │   ├── models.go
    │   └── users.sql.go
    ├── handlers/                    # HTTP request handlers
    │   ├── health.go
    │   ├── auth_handler.go
    │   ├── uber_oauth_handler.go
    │   └── ride_request_handler.go
    ├── middleware/                  # HTTP middleware
    │   ├── cors.go
    │   ├── error_handler.go
    │   └── auth.go
    ├── models/                      # Domain models
    │   ├── user.go
    │   └── ride_request.go
    ├── repositories/                # Database operations
    │   └── user_repository.go
    ├── services/                    # Business logic
    │   ├── auth_service.go
    │   ├── uber_service.go
    │   └── ride_service.go
    └── routes/                      # Route definitions
        └── routes.go
```

## Getting Started

### Prerequisites

- Go 1.23 or higher
- PostgreSQL 12 or higher
- sqlc (`go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest`)

### Installation

1. Clone and navigate to the project:
```bash
cd RideQwik
```

2. Install dependencies:
```bash
go mod download
```

3. Install sqlc:
```bash
go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest
# or
make install-tools
```

4. Generate type-safe database code:
```bash
sqlc generate
# or
make sqlc
```

5. Set up PostgreSQL:
```bash
createdb rideqwik
```

6. Configure environment:
```bash
cp .env.example .env
# Edit .env with your configuration
```

7. Run the application:
```bash
go run main.go
# or
make run
```

## API Endpoints

### Public Endpoints

#### Health Check
- `GET /health` - Check API health status

#### Authentication
- `POST /api/v1/auth/register` - Register a new user
- `POST /api/v1/auth/login` - Login and get JWT token

### Protected Endpoints (Require JWT Token)

#### User
- `GET /api/v1/user/me` - Get current user info

#### Uber OAuth
- `GET /api/v1/oauth/uber/authorize` - Get Uber authorization URL
- `GET /api/v1/oauth/uber/callback` - OAuth callback (returns token to frontend)

#### Rides
- `POST /api/v1/rides/requests` - Request ride options from platforms

## Example API Calls

### 1. Register a User
```bash
curl -X POST http://localhost:8080/api/v1/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123",
    "name": "John Doe",
    "phone": "+1234567890"
  }'
```

### 2. Login
```bash
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com",
    "password": "password123"
  }'
```

### 3. Connect Uber Account
```bash
# Step 1: Get authorization URL
curl -X GET http://localhost:8080/api/v1/oauth/uber/authorize \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Response contains auth_url - redirect user to this URL

# Step 2: After user authorizes, Uber redirects to callback
# Callback returns Uber token - frontend stores this token
```

### 4. Request Rides (with Uber token)
```bash
curl -X POST http://localhost:8080/api/v1/rides/requests \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "pickup_latitude": 37.7749,
    "pickup_longitude": -122.4194,
    "dropoff_latitude": 37.7849,
    "dropoff_longitude": -122.4094,
    "pickup_address": "123 Main St, SF",
    "dropoff_address": "456 Oak Ave, SF",
    "uber_token": "UBER_OAUTH_TOKEN_FROM_FRONTEND"
  }'
```

Response:
```json
{
  "success": true,
  "data": {
    "request_id": "req_123456",
    "options": [
      {
        "platform": "uber",
        "product_id": "abc123",
        "display_name": "UberX",
        "estimated_fare": 15.50,
        "eta_minutes": 5,
        "currency": "USD"
      }
    ]
  }
}
```

## Token Management

**Important**: OAuth tokens from ride platforms (Uber, Lyft, etc.) are **NOT** stored in the database.

- Frontend receives tokens from OAuth callback
- Frontend stores tokens (localStorage, secure storage, etc.)
- Frontend sends tokens with each ride request
- Backend validates and uses tokens to query platforms

## Database Schema

### Users Table
- `id` - Serial primary key
- `email` - Unique email address
- `password_hash` - Bcrypt hashed password
- `name` - User's full name
- `phone` - Phone number (nullable)
- `created_at` - Creation timestamp
- `updated_at` - Last update timestamp

## Using sqlc

sqlc generates type-safe Go code from SQL queries.

### 1. Write SQL Queries

Create/edit files in `internal/database/queries/`:

```sql
-- name: GetUserByEmail :one
SELECT * FROM users
WHERE email = $1;
```

### 2. Generate Code

```bash
sqlc generate
# or
make sqlc
```

### 3. Use Generated Code

```go
user, err := queries.GetUserByEmail(ctx, email)
```

### sqlc Benefits
- ✅ Type-safe database operations
- ✅ Compile-time SQL validation
- ✅ Auto-generated Go structs
- ✅ No reflection overhead
- ✅ SQL-first approach

## Development

### Running with Hot Reload
```bash
# Install air
go install github.com/cosmtrek/air@latest

# Run with hot reload
make dev
# or
air
```

### Database Migrations

Migrations run automatically on startup. Files in `internal/database/migrations/`.

To create a new migration:
1. Create `00X_migration_name.sql` in `internal/database/migrations/`
2. Add SQL statements
3. Restart the application

### Adding New Queries

1. Edit `internal/database/queries/*.sql`
2. Run `sqlc generate` or `make sqlc`
3. Use generated code in repositories

## Configuration

Environment variables (`.env` file):

| Variable | Description | Default |
|----------|-------------|---------|
| `PORT` | Server port | 8080 |
| `ENVIRONMENT` | Environment | development |
| `DB_HOST` | PostgreSQL host | localhost |
| `DB_PORT` | PostgreSQL port | 5432 |
| `DB_USER` | Database user | postgres |
| `DB_PASSWORD` | Database password | - |
| `DB_NAME` | Database name | rideqwik |
| `DB_SSLMODE` | SSL mode | disable |
| `JWT_SECRET` | JWT signing secret | - |
| `UBER_CLIENT_ID` | Uber OAuth client ID | - |
| `UBER_CLIENT_SECRET` | Uber OAuth client secret | - |
| `UBER_REDIRECT_URI` | Uber OAuth redirect URI | - |

## Architecture Decisions

### Why sqlc?
- Type-safe without ORM magic
- Fast (no reflection)
- SQL-first (full control)
- Great for PostgreSQL

### Why Frontend Token Storage?
- Simpler backend
- Better security (tokens isolated per user/device)
- Easier token expiration handling
- Frontend can refresh tokens independently

### Why pgx/v5?
- Better performance than database/sql
- Native PostgreSQL support
- Connection pooling
- Modern Go patterns

## Next Steps

- [ ] Add Lyft integration
- [ ] Add token refresh handling
- [ ] Add ride booking functionality
- [ ] Add user ride history
- [ ] Add WebSocket for real-time updates
- [ ] Add rate limiting
- [ ] Add request validation
- [ ] Add Swagger/OpenAPI docs
- [ ] Add comprehensive tests
- [ ] Add structured logging

## License

MIT License
